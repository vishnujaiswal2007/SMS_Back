static MakeResult = async (req, res) => {
    const client = new MongoClient(URL);

    try {
      const myobj = req.body;

      if (!myobj?.sem?.DB_CL || !myobj?.session) {
        return res.status(400).json({
          status: "Fail",
          message: "Invalid request data",
        });
      }

      await client.connect();
      const db = client.db("NepUG");
      const database = client.db("NEP");
      const collection = db.collection(`${myobj.sem.DB_CL}_RESULT`);
      const GradingSystem = await database
        .collection("GradeSystem")
        .find({})
        .toArray();

      const candidates = await collection
        .find({ Session: myobj.session })
        .toArray();

      if (!candidates.length) {
        return res.status(404).json({
          status: "Fail",
          message: "No students found for this session",
        });
      }

      // ========================
      // HELPER FUNCTIONS
      // ========================
      const safeInt = (v) => (v != null && !isNaN(v) ? Number(v) : 0);
      const calculateTotal = (arr) =>
        arr.map(safeInt).reduce((a, b) => a + b, 0);
      const checkAbsent = (arr) => arr.map(safeInt).every((m) => m === 0);
      const calc40Percent = (max) => Math.round(safeInt(max) * 0.4);
      const isPass = (obtained, max) => safeInt(obtained) >= calc40Percent(max);
      const calculatePercentage = (obtained, max) => {
        const o = safeInt(obtained);
        const m = safeInt(max);

        if (m === 0) return 0; // avoid division by zero
        return Math.round((o / m) * 100);
      };

      const bulkOps = [];
      const reportRows = [];

      // ========================
      // PROCESS EACH CANDIDATE
      // ========================
      for (const student of candidates) {
        const updateFields = {};

        // ---- Major 1 ----
        const major1TheoryObtained = calculateTotal([
          student.MajorDiscipline1Paper1Obtained,
          student.MajorDiscipline1Paper2Obtained,
          student.MajorDiscipline1Paper3Obtained,
        ]);
        const major1TheoryMax = calculateTotal([
          student.MajorDiscipline1Paper1Max,
          student.MajorDiscipline1Paper2Max,
          student.MajorDiscipline1Paper3Max,
        ]);
        const major1Cia = safeInt(student.MajorDiscipline1CiaObtained);
        const major1Practical = safeInt(
          student.MajorDiscipline1PracticalObtained
        );

        updateFields.MajorDiscipline1TheoryTotalObtained = major1TheoryObtained;
        updateFields.MajorDiscipline1TheoryTotalMax = major1TheoryMax;
        updateFields.MajorDiscipline1TotalObtained =
          major1TheoryObtained + major1Cia + major1Practical;

        //for grading: According to grading rules:-
        // Total Marks = CIA obtained + End Semester Marks
        const Major1GradeMarksObtained = major1Cia + major1TheoryObtained;
        const Major1GradeMarksMax =
          safeInt(student.MajorDiscipline1CiaMax) + major1TheoryMax;
        const Major1GradePercentage = calculatePercentage(
          Major1GradeMarksObtained,
          Major1GradeMarksMax
        );

        const Major1GradeAll = GradingSystem.find(
          (grade) =>
            Major1GradePercentage >= Number(grade.percentageMarksMin) &&
            Major1GradePercentage < Number(grade.percentageMarksMax)
        );

        //Absent Checking
        if (
          checkAbsent([
            student.MajorDiscipline1Paper1Obtained,
            student.MajorDiscipline1Paper2Obtained,
            student.MajorDiscipline1Paper3Obtained,
          ])
        ) {
          updateFields.MajorDiscipline1TheoryStatus = "ABSENT";
        }
        if (checkAbsent([student.MajorDiscipline1CiaObtained])) {
          updateFields.MajorDiscipline1CiaStatus = "ABSENT";
        }
        if (checkAbsent([student.MajorDiscipline1PracticalObtained])) {
          updateFields.MajorDiscipline1PracticalStatus = "ABSENT";
        }

        // ---- Major 2 ----
        const major2TheoryObtained = calculateTotal([
          student.MajorDiscipline2Paper1Obtained,
          student.MajorDiscipline2Paper2Obtained,
          student.MajorDiscipline2Paper3Obtained,
        ]);
        const major2TheoryMax = calculateTotal([
          student.MajorDiscipline2Paper1Max,
          student.MajorDiscipline2Paper2Max,
          student.MajorDiscipline2Paper3Max,
        ]);
        const major2Cia = safeInt(student.MajorDiscipline2CiaObtained);
        const major2Practical = safeInt(
          student.MajorDiscipline2PracticalObtained
        );

        updateFields.MajorDiscipline2TheoryTotalObtained = major2TheoryObtained;
        updateFields.MajorDiscipline2TheoryTotalMax = major2TheoryMax;
        updateFields.MajorDiscipline2TotalObtained =
          major2TheoryObtained + major2Cia + major2Practical;

        //for grading: According to grading rules:- Total Marks = CIA obtained + End Semester Marks
        const Major2GradeMarksObtained = major2Cia + major2TheoryObtained;
        const Major2GradeMarksMax =
          safeInt(student.MajorDiscipline2CiaMax) + major2TheoryMax;
        const Major2GradePercentage = calculatePercentage(
          Major2GradeMarksObtained,
          Major2GradeMarksMax
        );

        const Major2GradeAll = GradingSystem.find(
          (grade) =>
            Major2GradePercentage >= Number(grade.percentageMarksMin) &&
            Major2GradePercentage < Number(grade.percentageMarksMax)
        );

        //Absent Checking

        if (
          checkAbsent([
            student.MajorDiscipline2Paper1Obtained,
            student.MajorDiscipline2Paper2Obtained,
            student.MajorDiscipline2Paper3Obtained,
          ])
        ) {
          updateFields.MajorDiscipline2TheoryStatus = "ABSENT";
        }
        if (checkAbsent([student.MajorDiscipline2CiaObtained])) {
          updateFields.MajorDiscipline2CiaStatus = "ABSENT";
        }
        if (checkAbsent([student.MajorDiscipline2PracticalObtained])) {
          updateFields.MajorDiscipline2PracticalStatus = "ABSENT";
        }

        // ---- Minor ----
        const minorTotalObtained = calculateTotal([
          student.MinorDisciplinePaperObtained,
          student.MinorDisciplineCiaObtained,
          student.MinorDisciplinePracticalObtained,
        ]);
        updateFields.MinorDisciplineTotalObtained = minorTotalObtained;

        //for grading: According to grading rules:- Total Marks = CIA obtained + End Semester Marks
        const MinorGradeMarksObtained =
          safeInt(student.MinorDisciplineCiaObtained) +
          safeInt(student.MinorDisciplinePracticalObtained)+
          safeInt(student.MinorDisciplinePaperObtained);
        const MinorGradeMarksMax =
          safeInt(student.MinorDisciplineCiaMax) +
          safeInt(student.MinorDisciplinePracticalMax)+
          safeInt(student.MinorDisciplinePaperMax);
        const MinorGradePercentage = calculatePercentage(
          MinorGradeMarksObtained,
          MinorGradeMarksMax
        );

        const MinorGradeAll = GradingSystem.find(
          (grade) =>
            MinorGradePercentage >= Number(grade.percentageMarksMin) &&
            MinorGradePercentage < Number(grade.percentageMarksMax)
        );

        //Absent Check

        if (checkAbsent([student.MinorDisciplinePaperObtained])) {
          updateFields.MinorDisciplineTheoryStatus = "ABSENT";
        }

        if (checkAbsent([student.MinorDisciplineCiaObtained])) {
          updateFields.MinorDisciplineCiaStatus = "ABSENT";
        }

        if (checkAbsent([student.MinorDisciplinePracticalObtained])) {
          updateFields.MinorDisciplinePracticalStatus = "ABSENT";
        }

        // ---- PUSH TO BULK ----
        bulkOps.push({
          updateOne: {
            filter: { _id: student._id },
            update: { $set: updateFields },
          },
        });

        // ---- PREPARE REPORT ROW ----
        reportRows.push({
          EnrolmentNumber: student.EnrolmentNumber,
          RollNumber: student.RollNumber,

          //Major1
          Major1TotalTheoryObtained: major1TheoryObtained,
          Major1TotaTheorylMax: major1TheoryMax,
          Major1TheoryStatus:
            updateFields.MajorDiscipline1TheoryStatus === "ABSENT"
              ? "ABSENT"
              : isPass(major1TheoryObtained, major1TheoryMax)
              ? "PASS"
              : "FAIL",
          Major1CiaObtained: student.MajorDiscipline1CiaObtained,
          Major1CiaMax: student.MajorDiscipline1CiaMax,
          Major1PracticalObtained: student.MajorDiscipline1PracticalObtained,
          Major1PracticalMax: student.MajorDiscipline1PracticalMax,
          MajorDiscipline1TotalObtained:
            updateFields.MajorDiscipline1TotalObtained,
          MajorDiscipline1TotalMax: student.MajorDiscipline1TotalMax,
          MajorDiscipline1Status: !isPass(major1TheoryObtained, major1TheoryMax)
            ? "FAIL"
            : isPass(
                updateFields.MajorDiscipline1TotalObtained,
                student.MajorDiscipline1TotalMax
              )
            ? "PASS"
            : "FAIL",
          MajorDiscipline1Percentage: Major1GradePercentage,
          MajorDiscipline1GradePoint: Major1GradeAll.gradePoint,

          MajorDiscipline1LetterGrade: !isPass(
            major1TheoryObtained,
            major1TheoryMax
          )
            ? "F"
            : isPass(
                updateFields.MajorDiscipline1TotalObtained,
                student.MajorDiscipline1TotalMax
              )
            ? Major1GradeAll?.letterGrade || "F"
            : "F",

          MajorDiscipline1Classisfication: !isPass(
            major1TheoryObtained,
            major1TheoryMax
          )
            ? "FAIL"
            : isPass(
                updateFields.MajorDiscipline1TotalObtained,
                student.MajorDiscipline1TotalMax
              )
            ? Major1GradeAll?.classisfication || "FAIL"
            : "FAIL",

          //  MajorDiscipline1LetterGrade: Major1GradeAll.letterGrade,

          //  MajorDiscipline1Classisfication: Major1GradeAll.classisfication,

          //Major2

          Major2TotalTheoryObtained: major2TheoryObtained,
          Major2TotaTheorylMax: major2TheoryMax,
          Major2TheoryStatus:
            updateFields.MajorDiscipline2TheoryStatus === "ABSENT"
              ? "ABSENT"
              : isPass(major2TheoryObtained, major2TheoryMax)
              ? "PASS"
              : "FAIL",

          Major2CiaObtained: student.MajorDiscipline2CiaObtained,
          Major2CiaMax: student.MajorDiscipline2CiaMax,
          Major2PracticalObtained: student.MajorDiscipline2PracticalObtained,
          Major2PracticalMax: student.MajorDiscipline2PracticalMax,
          MajorDiscipline2TotalObtained:
            updateFields.MajorDiscipline2TotalObtained,
          MajorDiscipline2TotalMax: student.MajorDiscipline2TotalMax,
          MajorDiscipline2Status: !isPass(major2TheoryObtained, major2TheoryMax)
            ? "FAIL"
            : isPass(
                updateFields.MajorDiscipline2TotalObtained,
                student.MajorDiscipline2TotalMax
              )
            ? "PASS"
            : "FAIL",
          MajorDiscipline2Percentage: Major2GradePercentage,
          MajorDiscipline2GradePoint: Major2GradeAll.gradePoint,

          MajorDiscipline2LetterGrade: !isPass(
            major2TheoryObtained,
            major2TheoryMax
          )
            ? "FAIL"
            : isPass(
                updateFields.MajorDiscipline2TotalObtained,
                student.MajorDiscipline2TotalMax
              )
            ? Major2GradeAll?.letterGrade || "F"
            : "F",

          MajorDiscipline2Classisfication: !isPass(
            major2TheoryObtained,
            major2TheoryMax
          )
            ? "FAIL"
            : isPass(
                updateFields.MajorDiscipline2TotalObtained,
                student.MajorDiscipline2TotalMax
              )
            ? Major2GradeAll?.classisfication || "FAIL"
            : "FAIL",

          //  MajorDiscipline2LetterGrade: Major2GradeAll.letterGrade,
          //  MajorDiscipline2Classisfication: Major2GradeAll.classisfication,

          //Minor
          MinorTheoryTotalObtained: student.MinorDisciplinePaperObtained,
          MinorTheoryTotalMax: student.MinorDisciplinePaperMax,

          MinorTheoryStatus:
            updateFields.MinorDisciplineTheoryStatus === "ABSENT"
              ? "ABSENT"
              : isPass(
                  student.MinorDisciplinePaperObtained,
                  safeInt(student.MinorDisciplinePaperMax)
                )
              ? "PASS"
              : "FAIL",
          MinorCiaObtained: student.MinorDisciplineCiaObtained,
          MinorCiaMax: student.MinorDisciplineCiaMax,
          MinorPracticalObtained: student.MinorDisciplinePracticalObtained,
          MinorPracticalMax: student.MinorDisciplinePracticalMax,
          MinorDisciplineTotalObtained: MinorGradeMarksObtained,
          MinorDisciplineTotalMax: student.MinorDisciplineTotalMax,
          MinorDisciplineStatus: !isPass(student.MinorDisciplinePaperObtained, student.MinorDisciplinePaperMax)
            ? "FAIL"
            : isPass(MinorGradeMarksObtained, MinorGradeMarksMax)
            ? "PASS"
            : "FAIL",
          MinorPercentage: MinorGradePercentage,
          MinorGradePoint: MinorGradeAll.gradePoint,


          MinorDisciplineLetterGrade: !isPass(student.MinorDisciplinePaperObtained, student.MinorDisciplinePaperMax)
            ? "F"
            : isPass(MinorGradeMarksObtained, MinorGradeMarksMax)
            ? MinorGradeAll?.letterGrade || "F"
            : "F",

          MinorDisciplineClassisfication: !isPass(student.MinorDisciplinePaperObtained, student.MinorDisciplinePaperMax)
          ? "FAIL"
          : isPass(MinorGradeMarksObtained, MinorGradeMarksMax)
          ? MinorGradeAll?.classisfication || "FAIL"
          : "FAIL",


          // MinorLetterGrade: MinorGradeAll.letterGrade,
          // MinorClassisfication: MinorGradeAll.classisfication,
        });
      }

      // ========================
      // EXECUTE BULK WRITE
      // ========================
      if (bulkOps.length) {
        await collection.bulkWrite(bulkOps);
      }

      // ========================
      // GENERATE EXCEL REPORT
      // ========================
      const workbook = XLSX.utils.book_new();
      const worksheet = XLSX.utils.json_to_sheet(reportRows);
      XLSX.utils.book_append_sheet(workbook, worksheet, "ResultReport");

      const buffer = XLSX.write(workbook, { bookType: "xlsx", type: "buffer" });

      res.setHeader(
        "Content-Disposition",
        "attachment; filename=ResultReport.xlsx"
      );
      res.setHeader(
        "Content-Type",
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
      );

      return res.send(buffer);
    } catch (error) {
      console.error("MakeResult Error:", error);
      return res.status(500).json({
        status: "Error",
        message: "Internal Server Error",
      });
    } finally {
      await client.close();
    }
  };