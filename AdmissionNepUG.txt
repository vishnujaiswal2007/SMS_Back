static AdmissionNepUG = async (req, res) => {
    const myobj = req.body;
    let client;

    try {
      client = new MongoClient(URL);
      await client.connect();

      // -----------------------------
      // BASIC DATE INFO
      // -----------------------------
      const date = new Date();
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const year = date.getFullYear();
      const formattedDate = `${day}/${month}/${year}`;
      // const lastOfYear = String(year).slice(2);
      // const nextofYear = parseInt(lastOfYear) + 1;

      const PRG_CODE = req.body.PRG;
      
      // -----------------------------
      // READ EXCEL
      // -----------------------------
      const fileBuffer = req.file.buffer;
      const workbook = XLSX.read(fileBuffer, { type: "buffer" });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const data = XLSX.utils.sheet_to_json(sheet);

      let wrongRows = [];
      let recordsToInsert = [];

      // -----------------------------
      // PROCESS EACH ROW
      // -----------------------------
      let program;
      for (const row of data) {
        const CoursesDB = client.db("COURSES");
        const CodeDB = client.db("CODE");
        const discipline = client.db("NEP");
        const paper = client.db("NEP");

        //--------------
        //Discipline
        //-----------
        const disciplineMajor1 = await discipline
          .collection("Discipline")
          .findOne({ Number_Code: row.sb11 });
        const disciplineMajor2 = await discipline
          .collection("Discipline")
          .findOne({ Number_Code: row.sb12 });
        const disciplineMinor = await discipline
          .collection("Discipline")
          .findOne({ Number_Code: row.sb13 });

        //-------------------
        //Discipline Paper marks details
        //--------------------
        const disciplineMajor1Details = await discipline
          .collection("DiciplineDetails")
          .findOne({ DISCIPLINE: disciplineMajor1?.DISCIPLINE });
        const disciplineMajor2Details = await discipline
          .collection("DiciplineDetails")
          .findOne({ DISCIPLINE: disciplineMajor2?.DISCIPLINE });
        const disciplineMinorDetails = await discipline
          .collection("DiciplineDetails")
          .findOne({ DISCIPLINE: disciplineMinor?.DISCIPLINE });

        //-------------
        //Major and Minor Papers of Major Minor Discipline
        //-----------

        const paperMajorDiscipline1 = await paper
          .collection("PaperDetails")
          .find({
            CBCS_CATEGORY: "MAJOR",
            String_Code: disciplineMajor1?.String_Code,
          })
          .toArray();
        // const paperMinorDiscipline1 = await paper.collection("PaperDetails").findOne({CBCS_CATEGORY:"MINOR", String_Code: disciplineMajor1?.String_Code})

        const paperMajorDiscipline2 = await paper
          .collection("PaperDetails")
          .find({
            CBCS_CATEGORY: "MAJOR",
            String_Code: disciplineMajor2?.String_Code,
          })
          .toArray();
        // const paperMinorDiscipline2 = await paper.collection("PaperDetails").findOne({CBCS_CATEGORY:"MINOR", String_Code: disciplineMajor2?.String_Code})

        const paperMinorDiscipline = await paper
          .collection("PaperDetails")
          .findOne({
            CBCS_CATEGORY: "MINOR",
            String_Code: disciplineMinor?.String_Code,
          });

        // console.log("Paper", paperMajorDiscipline1)

        program = await CoursesDB.collection("COURSES").findOne({
          CourseNameCode: row.cc,
          TYPE: "NEP",
        });

        // WRONG PROGRAM
        if (!program || program.PRG_CODE !== PRG_CODE) {
          wrongRows.push(row);
          continue;
        }

        const unit = await CodeDB.collection("UNITCODE").findOne({
          Unit_Code: row.uc,
        });

        if (!unit) {
          wrongRows.push(row);
          console.log("Problem isin UNIT")
          continue;
        }

        //Regular or Ex
        const YearCat = row.cat === 1?"Regular Candidate": "Ex-Student"

        // INSERT CLEAN DATA
        recordsToInsert.push({
          Profile: {
            Session: myobj.session,
            FormNumber: row.fn,
            CuetRollNumber: row.trn,
            ProgrameName: program.Full_Form,
            Unit: unit ? unit.Unit_Name : null,
            EnrolmentNumber: row.en,
            Name: row.nm,
            FatherName: row.gn,
            MotherName: row.mn,
            ABCIdNumber: row.abc,
            Gender: row.gen,
            SocialCategory: row.scat,
            AdharNumber: row.adhar,
            DateofBirth: row.dob,
            YearOfAdmission: year,
            DateOfModification: "",
            DateofCreation: formattedDate,
            PDF: "PDF",
          },

          Result: {
            Session: myobj.session,
            EnrolmentNumber: row.en,
            RollNumber: row.rn,
            YearCategory: YearCat,
            //Discipline 1
            ...(disciplineMajor1?.DISCIPLINE && {
              MajorDiscipline1: disciplineMajor1.DISCIPLINE,
            }),

            ...(disciplineMajor1Details?.DISCIPLINE && {
              ...(disciplineMajor1Details?.MajorCiaMax != null && {
                MajorDiscipline1CiaMax: disciplineMajor1Details.MajorCiaMax,
                MajorDiscipline1CiaObtained: "",
              }),
              ...(disciplineMajor1Details?.MajorPracticleMax != null && {
                MajorDiscipline1PracticleMax:
                  disciplineMajor1Details.MajorPracticleMax,
                MajorDiscipline1PracticleObtained: "",
              }),

              ...(disciplineMajor1Details?.MajorPracticleCreditMax != null && {
                MajorDiscipline1PracticleCreditMax:
                  disciplineMajor1Details.MajorPracticleCreditMax,
                MajorDiscipline1PracticleObtained: "",
              }),
              ...(disciplineMajor1Details?.MajorTotalMax != null && {
                MajorDiscipline1TotalMax: disciplineMajor1Details.MajorTotalMax,
                MajorDiscipline1TotalObtained: "",
              }),

              ...(disciplineMajor1Details?.MajorTotalCreditMax != null && {
                MajorDiscipline1TotalCreditMax:
                  disciplineMajor1Details.MajorTotalCreditMax,
                MajorDiscipline1TotalCreditObtained: "",
              }),
            }),

            //Discipline 1 Major Paper 1

            ...(paperMajorDiscipline1[0]?.COURSE_NAME != null && {
              MajorDiscipline1Paper1: paperMajorDiscipline1[0]?.COURSE_NAME,
              ...(disciplineMajor1Details?.Major1Max != null && {
                MajorDiscipline1Paper1Max: disciplineMajor1Details?.Major1Max,
                MajorDiscipline1Paper1Obtained: "",
              }),
              ...(disciplineMajor1Details?.Major1CreditMax != null && {
                MajorDiscipline1Paper1CreditMax:
                  disciplineMajor1Details?.Major1CreditMax,
                MajorDiscipline1Paper1CreditObtained: "",
              }),
            }),

            //Discipline 1 Major Paper 2

            ...(paperMajorDiscipline1[1]?.COURSE_NAME != null && {
              MajorDiscipline1Paper2: paperMajorDiscipline1[1]?.COURSE_NAME,

              ...(disciplineMajor1Details?.Major2Max != null && {
                MajorDiscipline1Paper2Max: disciplineMajor1Details?.Major2Max,
                MajorDiscipline1Paper2Obtained: "",
              }),
              ...(disciplineMajor1Details?.Major2CreditMax != null && {
                MajorDiscipline1Paper2CreditMax:
                  disciplineMajor1Details?.Major2CreditMax,
                MajorDiscipline1Paper2CreditObtained: "",
              }),
            }),

            //Discipline 1 Major Paper 3

            ...(paperMajorDiscipline1[2]?.COURSE_NAME && {
              MajorDiscipline1Paper3: paperMajorDiscipline1[2]?.COURSE_NAME,
              ...(disciplineMajor1Details?.Major3Max != null && {
                MajorDiscipline1Paper3Max: disciplineMajor1Details?.Major3Max,
                MajorDiscipline1Paper3Obtained: "",
              }),
              ...(disciplineMajor1Details?.Major3CreditMax != null && {
                MajorDiscipline1Paper3CreditMax:
                  disciplineMajor1Details?.Major3CreditMax,
                MajorDiscipline1Paper3CreditObtained: "",
              }),
            }),

            //Discipline 1 Minor

            //  ...(paperMinorDiscipline1?.COURSE_NAME && {
            //   MajorDiscipline1Minor: paperMinorDiscipline1.COURSE_NAME,
            //   descipline1Minor1Max: disciplineMajor1Details?.Minor1Max||"",
            //   descipline1Minor1CreditMax: disciplineMajor1Details?.Minor1CreditMax||"",
            //   descipline1Minor1CiaMax: disciplineMajor1Details?.Minor1CiaMax||"",
            //   descipline1Minor1PracticalMax:disciplineMajor1Details?.Minor1PracticalMax||"",
            //   descipline1Minor1PracticalCreditMax:disciplineMajor1Details?.Minor1PracticalCreditMax||"",
            //   descipline1MinorTotalMax: disciplineMajor1Details?.MinorTotalMax||"",
            //   descipline1MinorCreditMax: disciplineMajor1Details?.MinorCreditMax||"",
            //  }),

            //Discipline 2
            ...(disciplineMajor2?.DISCIPLINE && {
              MajorDiscipline2: disciplineMajor2?.DISCIPLINE,
              ...(disciplineMajor2Details?.MajorCiaMax != null && {
                MajorDiscipline2CiaMax: disciplineMajor2Details?.MajorCiaMax,
                MajorDiscipline2CiaObtained: "",
              }),
              ...(disciplineMajor2Details?.MajorPracticleMax != null && {
                MajorDiscipline2PracticleMax:
                  disciplineMajor2Details?.MajorPracticleMax,
                MajorDiscipline2PracticleObtained: "",
              }),
              ...(disciplineMajor2Details?.MajorPracticleCreditMax != null && {
                MajorDiscipline2PracticleCreditMax:
                  disciplineMajor2Details?.MajorPracticleCreditMax,
                MajorDiscipline2PracticleCreditObtained: "",
              }),
              ...(disciplineMajor2Details?.MajorTotalMax != null && {
                MajorDiscipline2TotalMax:
                  disciplineMajor2Details?.MajorTotalMax,
                MajorDiscipline2TotalObtained: "",
              }),
              ...(disciplineMajor2Details?.MajorTotalCreditMax != null && {
                MajorDiscipline2TotalCreditMax:
                  disciplineMajor2Details?.MajorTotalCreditMax,
                MajorDiscipline2TotalCreditObtained: "",
              }),
            }),

            //Discipline 2 Major Paper 1

            ...(paperMajorDiscipline2[0]?.COURSE_NAME && {
              MajorDiscipline2Paper1: paperMajorDiscipline2[0]?.COURSE_NAME,
              ...(disciplineMajor2Details?.Major1Max != null && {
                MajorDiscipline2Paper1Max: disciplineMajor2Details?.Major1Max,
                MajorDiscipline2Paper1Obtained: "",
              }),
              ...(disciplineMajor2Details?.Major1CreditMax != null && {
                MajorDiscipline2Paper1CreditMax:
                  disciplineMajor2Details?.Major1CreditMax,
                MajorDiscipline2Paper1CreditObtained: "",
              }),
            }),

            //Discipline 2 Major Paper 2

            ...(paperMajorDiscipline2[1]?.COURSE_NAME && {
              MajorDiscipline2Paper2: paperMajorDiscipline2[1]?.COURSE_NAME,
              ...(disciplineMajor2Details?.Major2Max != null && {
                MajorDiscipline2Paper2Max: disciplineMajor2Details?.Major2Max,
                MajorDiscipline2Paper2Obtained: "",
              }),
              ...(disciplineMajor2Details?.Major2CreditMax != null && {
                MajorDiscipline2Paper2CreditMax:
                  disciplineMajor2Details?.Major2CreditMax,
                MajorDiscipline2Paper2CreditObtained: "",
              }),
            }),

            //Discipline 2 Major Paper 3

            ...(paperMajorDiscipline2[2]?.COURSE_NAME && {
              MajorDiscipline2Paper3: paperMajorDiscipline2[2]?.COURSE_NAME,
              ...(disciplineMajor2Details?.Major3Max != null && {
                MajorDiscipline2Paper3Max: disciplineMajor2Details?.Major3Max,
                MajorDiscipline2Paper3Obtained: "",
              }),
              ...(disciplineMajor2Details?.Major3CreditMax != null && {
                MajorDiscipline2Paper3CreditMax:
                  disciplineMajor2Details?.Major3CreditMax,
                MajorDiscipline2Paper3CreditObtained: "",
              }),
            }),

            //Discipline 2 Minor

            //  ...(paperMinorDiscipline2?.COURSE_NAME && {
            //   MajorDiscipline2Minor: paperMinorDiscipline2.COURSE_NAME,
            //   descipline2Minor1Max: disciplineMajor2Details?.Minor1Max||"",
            //   descipline2Minor1CreditMax: disciplineMajor2Details?.Minor1CreditMax||"",
            //   descipline2Minor1CiaMax: disciplineMajor2Details?.Minor1CiaMax||"",
            //   descipline2Minor1PracticalMax:disciplineMajor2Details?.Minor1PracticalMax||"",
            //   descipline2Minor1PracticalCreditMax:disciplineMajor2Details?.Minor1PracticalCreditMax||"",
            //   descipline2MinorTotalMax: disciplineMajor2Details?.MinorTotalMax||"",
            //   descipline2MinorCreditMax: disciplineMajor2Details?.MinorCreditMax||"",
            //  }),

            //Minor Discipline
            ...(disciplineMinorDetails?.DISCIPLINE && {
              MinorDiscipline: disciplineMinorDetails?.DISCIPLINE,
            }),

            //Minor  Discipline Papers
            ...(paperMinorDiscipline?.COURSE_NAME && {
              MinorDisciplinePaper: paperMinorDiscipline?.COURSE_NAME,
              ...(disciplineMinorDetails?.Minor1Max != null && {
                MinorDisciplinePaperMax: disciplineMinorDetails?.Minor1Max,
                MinorDisciplinePaperObtained: "",
              }),
              ...(disciplineMinorDetails?.Minor1CreditMax != null && {
                MinorDisciplinePaperCreditMax:
                  disciplineMinorDetails?.Minor1CreditMax,
                MinorDisciplinePaperCreditObtained: "",
              }),
              ...(disciplineMinorDetails?.Minor1CiaMax != null && {
                MinorDisciplineCiaMax: disciplineMinorDetails?.Minor1CiaMax,
                MinorDisciplineCiaObtained: "",
              }),
              ...(disciplineMinorDetails?.Minor1PracticalMax != null && {
                MinorDisciplinePracticalMax:
                  disciplineMinorDetails?.Minor1PracticalMax,
                MinorDisciplineCiaObtained: "",
              }),
              ...(disciplineMinorDetails?.Minor1PracticalCreditMax != null && {
                MinorDisciplinePracticalCreditMax:
                  disciplineMinorDetails?.Minor1PracticalCreditMax,
                MinorDisciplinePracticalCreditObtained: "",
              }),
              ...(disciplineMinorDetails?.MinorTotalMax != null && {
                MinorDisciplineTotalMax: disciplineMinorDetails?.MinorTotalMax,
                MinorDisciplineTotalObtained: "",
              }),
              ...(disciplineMinorDetails?.MinorCreditMax != null && {
                MinorDisciplineCreditMax:
                  disciplineMinorDetails?.MinorCreditMax,
                MinorDisciplineCreditObtained: "",
              }),
            }),
            ...(row?.skil != null && {
              Skill: row?.skil,
            }),
          },

          //Transcript
          TS: {
            DB_CL: program.DB_CL + "1",
            Session: myobj.session,
            EnrolmentNumber: row.en,
            RollNumber: row.rn,
            ...(disciplineMajor1?.DISCIPLINE != null && {
              MajorDiscipline1: disciplineMajor1?.DISCIPLINE,
            }),
            ...(paperMajorDiscipline1[0]?.COURSE_NAME != null && {
              MajorDiscipline1Paper1: paperMajorDiscipline1[0]?.COURSE_NAME,
            }),
            ...(paperMajorDiscipline1[1]?.COURSE_NAME != null && {
              MajorDiscipline1Paper2: paperMajorDiscipline1[1]?.COURSE_NAME,
            }),
            ...(paperMajorDiscipline1[2]?.COURSE_NAME != null && {
              MajorDiscipline1Paper3: paperMajorDiscipline1[2]?.COURSE_NAME,
            }),
            ...(disciplineMajor2?.DISCIPLINE != null && {
              MajorDiscipline2: disciplineMajor2?.DISCIPLINE,
            }),
            ...(paperMajorDiscipline2[0]?.COURSE_NAME != null && {
              MajorDiscipline2Paper1: paperMajorDiscipline2[0]?.COURSE_NAME,
            }),
            ...(paperMajorDiscipline2[1]?.COURSE_NAME != null && {
              MajorDiscipline2Paper2: paperMajorDiscipline2[1]?.COURSE_NAME,
            }),
            ...(paperMajorDiscipline2[2]?.COURSE_NAME != null && {
              MajorDiscipline2Paper3: paperMajorDiscipline2[2]?.COURSE_NAME,
            }),
            ...(disciplineMinor?.DISCIPLINE != null && {
              MinorDiscipline: disciplineMinor?.DISCIPLINE,
            }),
            ...(paperMinorDiscipline?.COURSE_NAME != null && {
              MinorDisciplinePaper: paperMinorDiscipline?.COURSE_NAME,
            }),
            ...(row?.skil != null && {
              Skill: row?.skil,
            }),
          },
        });
      }

      // -----------------------------
      // SEPARATE INTO 3 COLLECTION ARRAYS
      // -----------------------------
      let profileData = [];
      let resultData = [];
      let tsData = [];

      for (const rec of recordsToInsert) {
        profileData.push(rec.Profile);
        resultData.push(rec.Result);
        tsData.push(rec.TS);
      }

      // -----------------------------
      // INSERT INTO 3 COLLECTIONS
      // -----------------------------
      const AdmissionDB = client.db("NepUG");

      if (profileData.length > 0) {
        await AdmissionDB.collection(`${program.DB_CL}_PROFILE`).insertMany(
          profileData
        );
      }

      if (resultData.length > 0) {
        await AdmissionDB.collection(`${program.DB_CL}1_RESULT`).insertMany(
          resultData
        );
      }

      if (tsData.length > 0) {
        await AdmissionDB.collection(`${program.DB_CL}_TS`).insertMany(tsData);
      }

      // -----------------------------
      // HANDLE WRONG PROGRAM ROWS
      // -----------------------------
      if (wrongRows.length > 0) {
        const ws = XLSX.utils.json_to_sheet(wrongRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Wrong_Data");

        const exportBuffer = XLSX.write(wb, {
          type: "buffer",
          bookType: "xlsx",
        });

        res.setHeader(
          "Content-Disposition",
          "attachment; filename=wrong_Data_codes.xlsx"
        );
        res.setHeader(
          "Content-Type",
          "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        );
        res.setHeader(
          "X-Message",
          `Total ${recordsToInsert.length} valid candidates`
        );

        return res.send(exportBuffer);
      }

      // -----------------------------
      // FINAL SUCCESS RESPONSE
      // -----------------------------
      res.status(200).send({
        status: "Success",
        message: `Total ${recordsToInsert.length} candidates of ${program.Full_Form}`,
      });
    } catch (error) {
      console.log(error);
      res.status(400).send({
        status: "Failed",
        message: "There is some problem",
      });
    } finally {
      await client.close();
    }
  };